import qs from "qs"

export default class {
  static get(path, data = null) {
    if (data) {
      var pathParamsString = qs.stringify(data, {"arrayFormat": "brackets"})
      path += `?${pathParamsString}`
    }

    return new Promise((resolve, reject) => {
      var xhr = new XMLHttpRequest()
      xhr.open("GET", path)
      xhr.setRequestHeader("Content-Type", "application/json")
      xhr.setRequestHeader("X-CSRF-Token", this._token())
      xhr.onload = () => {
        var response = this._parseResponse(xhr)

        if (xhr.status == 200) {
          resolve(response)
        } else {
          reject(response)
        }
      }
      xhr.send()
    })
  }

  static patch(path, data = {}) {
    return this._request({"path": path, "data": data, "method": "PATCH"})
  }

  static post(path, data = {}) {
    return this._request({"path": path, "data": data, "method": "POST"})
  }

  static put(path, data = {}) {
    return this._request({"path": path, "data": data, "method": "PUT"})
  }

  static _token() {
    var tokenElement = document.querySelector("meta[name='csrf-token']")

    if (tokenElement)
      return tokenElement.getAttribute("content")
  }

  static _parseResponse(xhr) {
    var responseType = xhr.getResponseHeader("content-type")

    if (responseType.startsWith("application/json")) {
      return JSON.parse(xhr.responseText)
    } else {
      return xhr.responseText
    }
  }

  static _request(args) {
    return new Promise((resolve, reject) => {
      var xhr = new XMLHttpRequest()
      xhr.open(args.method, args.path)
      xhr.setRequestHeader("Content-Type", "application/json")
      xhr.setRequestHeader("X-CSRF-Token", this._token())
      xhr.onload = () => {
        var response = this._parseResponse(xhr)

        if (xhr.status == 200) {
          resolve(response)
        } else {
          reject(response)
        }
      }
      xhr.send(JSON.stringify(args.data))
    })
  }
}
